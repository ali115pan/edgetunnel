name: Auto Sync Upstream

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]

permissions:
  contents: write  # å…³é”®ï¼šéœ€è¦å†™æƒé™æ‰èƒ½ push
  actions: read

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.repository_owner != 'github-actions[bot]'  # é˜²æ­¢åœ¨ fork ä»“åº“ä¸­è¿è¡Œ

    steps:
      - name: Debug info
        run: |
          echo "ğŸ·ï¸ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”§ äº‹ä»¶: ${{ github.event_name }}"
          echo "ğŸ•’ æ—¶é—´: $(date)"
          echo "ğŸ‘¤ ç”¨æˆ·: ${{ github.actor }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GITHUB_TOKEN è€Œéé»˜è®¤ token

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          if ! git remote get-url upstream &>/dev/null; then
            git remote add upstream https://github.com/cmliu/edgetunnel.git
          else
            git remote set-url upstream https://github.com/cmliu/edgetunnel.git
          fi

      - name: Fetch upstream
        run: |
          echo "ğŸ“¥ æ­£åœ¨è·å–ä¸Šæ¸¸æ›´æ–°..."
          git fetch upstream

      - name: Check and merge
        id: merge
        run: |
          UPSTREAM_MAIN="upstream/main"
          CURRENT_BRANCH="origin/main"

          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          git rev-parse --verify "$UPSTREAM_MAIN" || {
            echo "âš ï¸ upstream/main ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå¹¶"
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦è½åäºä¸Šæ¸¸
          if git merge-base --is-ancestor "$UPSTREAM_MAIN" "$CURRENT_BRANCH"; then
            echo "âœ… å·²ç»æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            echo "has_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸ”„ å‘ç°æ›´æ–°ï¼Œå¼€å§‹åˆå¹¶..."
            git merge "$UPSTREAM_MAIN" --no-edit -m "Merge upstream/main into main"
            echo "has_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.merge.outputs.has_update == 'true'
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€åˆ°è¿œç¨‹..."
          git push origin main
          echo "âœ… æ¨é€å®Œæˆ"

      - name: Push info
        if: steps.merge.outputs.has_update != 'true'
        run: |
          echo "ğŸ“­ æ— æ›´æ–°ï¼Œæ— éœ€æ¨é€"

      - name: Finish
        run: |
          echo "ğŸ‰ åŒæ­¥æµç¨‹ç»“æŸäº $(date)"
          echo "â° å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
