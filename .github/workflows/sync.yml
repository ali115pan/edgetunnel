name: Simple Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿ
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug info
        run: |
          echo "ğŸ·ï¸ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”§ äº‹ä»¶: ${{ github.event_name }}"
          echo "ğŸ•’ æ—¶é—´: $(date)"
          
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/cmliu/edgetunnel.git || git remote set-url upstream https://github.com/cmliu/edgetunnel.git
          
      - name: Fetch upstream
        run: git fetch upstream
        
      - name: Merge changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if git merge-base --is-ancestor upstream/main main; then
            echo "âœ… å·²ç»æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
          else
            echo "ğŸ”„ å‘ç°æ›´æ–°ï¼Œå¼€å§‹åˆå¹¶..."
            git merge upstream/main --no-edit
            echo "âœ… åˆå¹¶å®Œæˆ"
          fi
          
      - name: Push changes if needed
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æäº¤
          if git status --porcelain | grep -q .; then
            echo "ğŸ“¤ æœ‰æ›´æ–°ï¼Œæ¨é€åˆ°è¿œç¨‹..."
            git push origin main
          else
            echo "ğŸ“­ æ— æ›´æ–°ï¼Œè·³è¿‡æ¨é€"
          fi
          
      - name: Finish
        run: echo "ğŸ‰ åŒæ­¥æµç¨‹ç»“æŸäº $(date)"
